<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Corre√ß√£o Profissional</title>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        :root {
            --primary-blue: #003366;
            --light-blue: #f0f4f8;
            --accent-red: #d9534f;
            --text-main: #333;
            --gray-border: #e1e4e8;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #fdfdfd; margin: 0; color: var(--text-main); }

        /* Login */
        #login-overlay { position: fixed; inset: 0; background: var(--primary-blue); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .login-card { background: white; padding: 2rem; border-radius: 12px; text-align: center; width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .login-card input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn-login { width: 100%; padding: 12px; background: var(--accent-red); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }

        /* Estrutura */
        #main-system { display: none; height: 100vh; flex-direction: column; }
        header { background: white; padding: 10px 20px; border-bottom: 1px solid var(--gray-border); display: flex; align-items: center; justify-content: space-between; }
        nav { background: white; display: flex; justify-content: center; gap: 30px; border-bottom: 1px solid var(--gray-border); }
        .nav-link { border: none; background: none; padding: 15px; cursor: pointer; color: #666; font-weight: bold; text-transform: uppercase; font-size: 0.85rem; border-bottom: 3px solid transparent; }
        .nav-link.active { color: var(--primary-blue); border-bottom-color: var(--primary-blue); }

        main { flex: 1; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .tab-pane { display: none; max-width: 900px; margin: 0 auto; }
        .tab-pane.active { display: block; }

        /* Barra de Progresso */
        .progress-container { width: 100%; background-color: #eee; border-radius: 10px; margin: 20px 0; display: none; height: 20px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: var(--accent-red); width: 0%; transition: width 0.4s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold; }

        /* ABA RESULTADOS */
        .res-header { display: flex; gap: 20px; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .res-sub-link { padding: 10px 0; cursor: pointer; color: #999; font-weight: bold; position: relative; }
        .res-sub-link.active { color: var(--primary-blue); }
        .res-sub-link.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 3px; background: var(--primary-blue); }

        .comp-card { background: white; border: 1px solid #eee; border-radius: 8px; padding: 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .comp-selector { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 25px 0; }
        .comp-btn { padding: 10px 20px; border: 1px solid #ccc; background: white; cursor: pointer; font-weight: bold; min-width: 60px; transition: 0.2s; border-radius: 4px; }
        .comp-btn.active { background: #ecdada; border-color: #d9534f; color: #333; }

        .field-label { font-weight: bold; color: var(--primary-blue); margin: 20px 0 8px; font-size: 0.95rem; }
        .desc-box { background: var(--light-blue); padding: 15px; border-radius: 4px; font-size: 0.9rem; line-height: 1.5; margin-bottom: 20px; }
        .score-select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; background: #fff; font-size: 1rem; color: #666; }
        .text-feedback { background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 15px; min-height: 100px; font-size: 0.95rem; line-height: 1.6; color: #444; white-space: pre-wrap; }

        .crit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .crit-item { background: #f9f9f9; padding: 10px; border-radius: 4px; border-left: 4px solid #ddd; font-size: 0.85rem; display: flex; gap: 8px; }

        textarea { width: 100%; height: 400px; padding: 15px; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; box-sizing: border-box; }
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary { background: var(--accent-red); color: white; }
        .btn-clear { background: #666; color: white; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-card">
        <i data-lucide="lock" style="color:var(--accent-red)"></i>
        <h3>Acesso Restrito</h3>
        <input type="password" id="passInput" placeholder="Sua senha">
        <button class="btn-login" onclick="login()">Entrar</button>
    </div>
</div>

<div id="main-system">
    <header>
        <div style="display:flex; align-items:center; gap:10px;"><i data-lucide="home"></i> <b>ENEM</b></div>
        <div style="font-size:0.8rem; color:#888"><i data-lucide="cpu" style="width:14px"></i> Engine Local Ativa</div>
    </header>

    <nav>
        <button class="nav-link active" onclick="showTab('scanner')">Digitalizar</button>
        <button class="nav-link" onclick="showTab('editor')">Editor</button>
        <button class="nav-link" onclick="showTab('results')">Resultado</button>
    </nav>

    <main>
        <div id="scanner" class="tab-pane active">
            <div class="comp-card">
                <h3>Escanear Folha</h3>
                <input type="file" id="fileIn" accept="image/*" style="margin-bottom:15px;" onchange="previewImg(this)">
                <img id="prevImg" style="max-width:100%; display:none; border-radius:8px; margin-bottom:15px;">
                <button class="btn btn-primary" onclick="doOCR()">Digitalizar para Editor</button>
                <button class="btn btn-clear" style="margin-top:10px" onclick="clearScan()">Limpar Scanner</button>
            </div>
        </div>

        <div id="editor" class="tab-pane">
            <div class="comp-card">
                <textarea id="essayText" placeholder="O texto aparecer√° aqui..."></textarea>
                
                <div class="progress-container" id="progCont">
                    <div class="progress-bar" id="progBar">0%</div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" id="btnCorr" onclick="startCorrection()">üöÄ Corrigir Agora</button>
                    <button class="btn btn-clear" onclick="clearEditor()">Limpar Aba</button>
                </div>
            </div>
        </div>

        <div id="results" class="tab-pane">
            <div class="comp-card">
                <div class="res-header">
                    <div id="sub-par" class="res-sub-link active" onclick="toggleSub('par')">Par√¢metros</div>
                    <div id="sub-ind" class="res-sub-link" onclick="toggleSub('ind')">Indicadores</div>
                </div>

                <div id="view-par">
                    <h3 style="margin-top:0">Compet√™ncias</h3>
                    <div class="comp-selector">
                        <button class="comp-btn active" onclick="setComp(1)">C1</button>
                        <button class="comp-btn" onclick="setComp(2)">C2</button>
                        <button class="comp-btn" onclick="setComp(3)">C3</button>
                        <button class="comp-btn" onclick="setComp(4)">C4</button>
                        <button class="comp-btn" onclick="setComp(5)">C5</button>
                    </div>

                    <div id="comp-label-desc" class="desc-box">Demonstrar dom√≠nio da modalidade escrita formal...</div>

                    <div class="field-label">Pontua√ß√£o Estimada</div>
                    <select class="score-select" id="score-val" disabled>
                        <option value="0">0</option><option value="40">40</option><option value="80">80</option><option value="120">120</option><option value="160">160</option><option value="200">200</option>
                    </select>

                    <div class="field-label">Pontos positivos</div>
                    <div id="pos-box" class="text-feedback">Aguardando corre√ß√£o...</div>

                    <div class="field-label">Como melhorar (Sugest√µes)</div>
                    <div id="imp-box" class="text-feedback">Aguardando corre√ß√£o...</div>
                </div>

                <div id="view-ind" style="display:none;">
                    <div class="crit-grid" id="crit-list"></div>
                </div>
                
                <button class="btn btn-clear" style="margin-top:20px; width:100%" onclick="clearResults()">Limpar Resultados</button>
            </div>
        </div>
    </main>
</div>

<script>
    lucide.createIcons();
    
    // --- CONFIGURA√á√ÉO DA URL (ATUALIZE AQUI!) ---
    const API_URL = "https://carolann-unfrosty-semiliberally.ngrok-free.dev/v1";

    let curComp = 1;
    let feedbackData = {};

    const comps = {
        1: "Compet√™ncia 1: Demonstrar dom√≠nio da modalidade escrita formal da l√≠ngua portuguesa.",
        2: "Compet√™ncia 2: Compreender a proposta de reda√ß√£o e aplicar conceitos de v√°rias √°reas.",
        3: "Compet√™ncia 3: Selecionar, organizar e interpretar informa√ß√µes em defesa de um ponto de vista.",
        4: "Compet√™ncia 4: Conhecimento dos mecanismos lingu√≠sticos para constru√ß√£o da argumenta√ß√£o.",
        5: "Compet√™ncia 5: Elaborar proposta de interven√ß√£o que respeite os direitos humanos."
    };

    const criteria = {
        1: ["Ilegibilidade/Rasuras", "Mai√∫sculas/Min√∫sculas", "Ortografia", "Acentua√ß√£o", "Translinea√ß√£o", "H√≠fen", "Pontua√ß√£o/Truncamento", "Pontua√ß√£o/Justaposi√ß√£o", "Outros de pontua√ß√£o", "Sintaxe/Falta", "Sintaxe/Excesso", "Crase", "Reg√™ncia", "Concord√¢ncia", "Modo/Tempo Verbal", "Pronomes", "Paralelismo", "Vocabul√°rio", "Coloquialismo", "Figurada"],
        2: ["Tangenciamento", "Tipo textual", "Repert√≥rio restrito", "N√£o legitimado", "N√£o pertinente", "Improdutivo", "Legitimado/Produtivo"],
        3: ["Tangenciamento", "Relacionamento", "Expositivo", "Desenvolvimento", "Confuso", "Contradi√ß√£o", "Repeti√ß√£o", "Prolixo", "Modaliza√ß√£o", "Progress√£o", "Tese", "Interven√ß√£o", "Argumentado", "Estrat√©gico"],
        4: ["Coesivo interpar√°grafo", "Operador", "Ambiguidade", "Mau uso", "Repeti√ß√£o"],
        5: ["Sem proposta", "Sem assunto", "Direitos humanos", "Tangenciamento", "Condicional", "Agente", "A√ß√£o", "Meio/Modo", "Efeito", "Detalhamento", "Completa"]
    };

    function login() { if(document.getElementById('passInput').value === 'beatriz') { document.getElementById('login-overlay').style.display='none'; document.getElementById('main-system').style.display='flex'; } }
    
    function showTab(id) { 
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(window.event) window.event.currentTarget.classList.add('active');
    }

    function toggleSub(t) {
        document.getElementById('view-par').style.display = t === 'par' ? 'block' : 'none';
        document.getElementById('view-ind').style.display = t === 'ind' ? 'block' : 'none';
        document.getElementById('sub-par').classList.toggle('active', t === 'par');
        document.getElementById('sub-ind').classList.toggle('active', t === 'ind');
        if(t === 'ind') renderCrits();
    }

    function setComp(n) {
        curComp = n;
        document.querySelectorAll('.comp-btn').forEach((b, i) => b.classList.toggle('active', i+1 === n));
        document.getElementById('comp-label-desc').innerText = comps[n];
        document.getElementById('pos-box').innerText = feedbackData[`c${n}_pos`] || "Sem dados para esta compet√™ncia.";
        document.getElementById('imp-box').innerText = feedbackData[`c${n}_imp`] || "Sem dados para esta compet√™ncia.";
        document.getElementById('score-val').value = feedbackData[`c${n}_score`] || "0";
        if(document.getElementById('view-ind').style.display === 'block') renderCrits();
    }

    function renderCrits() {
        const list = document.getElementById('crit-list');
        const offset = [0, 0, 20, 27, 41, 46][curComp];
        list.innerHTML = criteria[curComp].map((c, i) => `<div class="crit-item"><b>${offset + i + 1}</b> ${c}</div>`).join('');
    }

    function previewImg(i) { const r = new FileReader(); r.onload = e => { const m = document.getElementById('prevImg'); m.src = e.target.result; m.style.display='block'; }; r.readAsDataURL(i.files[0]); }
    
    async function doOCR() { 
        const res = await Tesseract.recognize(document.getElementById('prevImg').src, 'por');
        document.getElementById('essayText').value = res.data.text;
        showTab('editor'); 
    }

    async function startCorrection() {
        const txt = document.getElementById('essayText').value;
        if(!txt) return alert("Por favor, insira um texto!");

        const btn = document.getElementById('btnCorr');
        const progCont = document.getElementById('progCont');
        const progBar = document.getElementById('progBar');

        btn.disabled = true;
        progCont.style.display = 'block';
        progBar.style.width = '30%';
        progBar.innerText = 'Enviando para GPU...';

        const systemPrompt = "Voc√™ √© um corretor rigoroso do ENEM. Retorne APENAS um JSON com estas chaves: c1_score, c1_pos, c1_imp, c2_score, c2_pos, c2_imp, c3_score, c3_pos, c3_imp, c4_score, c4_pos, c4_imp, c5_score, c5_pos, c5_imp. N√£o inclua Markdown ou textos extras.";

        try {
            const r = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                body: JSON.stringify({
                    model: "local-model",
                    messages: [{role:"system", content: systemPrompt}, {role:"user", content: txt}],
                    temperature: 0.1
                })
            });

            progBar.style.width = '70%';
            progBar.innerText = 'Processando an√°lise...';

            const d = await r.json();
            let content = d.choices[0].message.content;
            content = content.replace(/```json/g, "").replace(/```/g, "").trim();
            
            feedbackData = JSON.parse(content);
            
            progBar.style.width = '100%';
            progBar.innerText = 'Conclu√≠do!';
            
            setTimeout(() => {
                showTab('results');
                setComp(1);
                progCont.style.display = 'none';
                btn.disabled = false;
            }, 800);

        } catch(e) { 
            console.error(e);
            alert("Erro na conex√£o. Verifique se o Ngrok e o LM Studio est√£o ativos.");
            progCont.style.display = 'none';
            btn.disabled = false;
        }
    }

    function clearScan() { document.getElementById('prevImg').style.display='none'; document.getElementById('fileIn').value=''; }
    function clearEditor() { document.getElementById('essayText').value=''; }
    function clearResults() { feedbackData={}; setComp(1); }
</script>
</body>
</html>