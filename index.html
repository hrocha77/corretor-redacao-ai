<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CorreÃ§Ã£o ENEM Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0d0d14;
            --surface: #13131f;
            --surface2: #1a1a2e;
            --border: #2a2a45;
            --accent: #e63946;
            --accent2: #ff6b6b;
            --gold: #f4a261;
            --text: #e8e8f0;
            --muted: #7070a0;
            --success: #2ec4b6;
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #login-overlay {
            position: fixed; inset: 0;
            background: var(--bg);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .login-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 3rem 2.5rem;
            width: 360px;
            text-align: center;
            box-shadow: 0 0 60px rgba(230,57,70,0.15);
        }
        .login-logo {
            font-family: 'Syne', sans-serif;
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.25rem;
        }
        .login-sub { color: var(--muted); font-size: 0.85rem; margin-bottom: 2rem; }
        .login-card input {
            width: 100%; padding: 14px 16px;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text); font-size: 1rem;
            outline: none; margin-bottom: 1rem;
            transition: border-color 0.2s;
        }
        .login-card input:focus { border-color: var(--accent); }
        .btn-login {
            width: 100%; padding: 14px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: white; border: none;
            border-radius: var(--radius);
            font-weight: 700; font-size: 1rem;
            cursor: pointer; letter-spacing: 0.5px;
            transition: opacity 0.2s, transform 0.1s;
        }
        .btn-login:hover { opacity: 0.9; transform: translateY(-1px); }
        .login-err { color: var(--accent2); font-size: 0.8rem; margin-top: 0.5rem; min-height: 1rem; }

        /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #main-system { display: none; flex-direction: column; height: 100vh; }
        header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            display: flex; align-items: center; justify-content: space-between;
            flex-shrink: 0;
        }
        .header-brand {
            font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.2rem;
            background: linear-gradient(135deg, var(--accent), var(--gold));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .header-status {
            display: flex; align-items: center; gap: 8px;
            font-size: 0.75rem; color: var(--muted);
        }
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: #555; transition: background 0.3s;
        }
        .status-dot.online { background: var(--success); box-shadow: 0 0 6px var(--success); }
        .status-dot.error { background: var(--accent); box-shadow: 0 0 6px var(--accent); }
        .status-dot.checking { background: var(--gold); animation: blink-dot 0.7s ease-in-out infinite; }
        @keyframes blink-dot {
            0%, 100% { opacity: 1; box-shadow: 0 0 8px var(--gold); }
            50%       { opacity: 0.15; box-shadow: none; }
        }

        /* â”€â”€ NAVBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        nav {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: center; gap: 4px;
            padding: 0 16px; flex-shrink: 0;
        }
        .nav-link {
            border: none; background: none;
            padding: 14px 22px; cursor: pointer;
            color: var(--muted); font-weight: 600;
            font-size: 0.8rem; letter-spacing: 1px;
            text-transform: uppercase;
            border-bottom: 2px solid transparent;
            transition: color 0.2s, border-color 0.2s;
        }
        .nav-link:hover { color: var(--text); }
        .nav-link.active { color: var(--accent); border-bottom-color: var(--accent); }

        /* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        main { flex: 1; overflow-y: auto; padding: 24px; }
        .tab-pane { display: none; max-width: 860px; margin: 0 auto; animation: fadeIn 0.3s; }
        .tab-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 28px;
        }
        .card-title {
            font-family: 'Syne', sans-serif; font-weight: 700;
            font-size: 1.1rem; margin-bottom: 20px;
            display: flex; align-items: center; gap: 10px;
        }
        .card-title svg { color: var(--accent); }

        /* â”€â”€ SCANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            position: relative;
        }
        .upload-zone:hover { border-color: var(--accent); background: rgba(230,57,70,0.04); }
        .upload-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .upload-icon { color: var(--muted); margin-bottom: 12px; }
        .upload-text { color: var(--muted); font-size: 0.9rem; }
        .upload-text span { color: var(--accent); font-weight: 600; }
        #prevImg { max-width: 100%; border-radius: var(--radius); margin: 16px 0; border: 1px solid var(--border); display: none; }
        .ocr-progress { display: none; margin-top: 12px; }

        /* â”€â”€ EDITOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .editor-meta {
            display: flex; gap: 12px; margin-bottom: 12px;
            font-size: 0.8rem; color: var(--muted);
        }
        .meta-badge {
            background: var(--surface2); border: 1px solid var(--border);
            border-radius: 6px; padding: 4px 10px;
        }
        textarea {
            width: 100%; height: 380px; padding: 18px;
            background: var(--surface2); border: 1px solid var(--border);
            border-radius: var(--radius); color: var(--text);
            font-size: 0.95rem; line-height: 1.75; resize: vertical;
            outline: none; transition: border-color 0.2s;
            font-family: 'Georgia', serif;
        }
        textarea:focus { border-color: var(--accent); }
        textarea::placeholder { color: var(--muted); }

        .btn-group { display: flex; gap: 10px; margin-top: 14px; }
        .btn {
            flex: 1; padding: 14px; border: none;
            border-radius: var(--radius); cursor: pointer;
            font-weight: 700; font-size: 0.9rem;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: opacity 0.2s, transform 0.1s;
        }
        .btn:hover:not(:disabled) { opacity: 0.88; transform: translateY(-1px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent2)); color: white; }
        .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); flex: 0 0 auto; padding: 14px 20px; }

        /* â”€â”€ API CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .api-config {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 20px;
            margin-bottom: 16px;
            display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
        }
        .api-config label { font-size: 0.8rem; color: var(--muted); font-weight: 600; white-space: nowrap; }
        .api-config input {
            flex: 1; min-width: 200px;
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 8px; padding: 8px 12px;
            color: var(--text); font-size: 0.85rem; outline: none;
            transition: border-color 0.2s;
        }
        .api-config input:focus { border-color: var(--accent); }
        .btn-test {
            padding: 8px 16px;
            background: transparent; border: 1px solid var(--success);
            color: var(--success); border-radius: 8px;
            cursor: pointer; font-size: 0.8rem; font-weight: 600;
            transition: background 0.2s;
        }
        .btn-test:hover { background: rgba(46,196,182,0.1); }

        /* â”€â”€ PROGRESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .progress-wrap { margin-bottom: 24px; display: none; }
        .progress-header { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 8px; }
        .progress-label { color: var(--muted); }
        .progress-pct { color: var(--accent); font-weight: 700; }
        .progress-track {
            background: var(--surface2); border-radius: 100px;
            height: 8px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; width: 0%;
            background: linear-gradient(90deg, var(--accent), var(--gold));
            border-radius: 100px;
            transition: width 0.5s cubic-bezier(0.4,0,0.2,1);
            position: relative; overflow: hidden;
        }
        .progress-fill::after {
            content: '';
            position: absolute; inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.25), transparent);
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { from { transform: translateX(-100%); } to { transform: translateX(100%); } }
        .comp-steps { display: flex; gap: 6px; margin-top: 12px; }
        .comp-step {
            flex: 1; height: 4px; border-radius: 100px;
            background: var(--surface2); transition: background 0.4s;
        }
        .comp-step.done { background: var(--success); }
        .comp-step.active { background: var(--accent); animation: pulse 1s infinite; }
        .comp-step.error { background: var(--accent); }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* â”€â”€ RESULTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .score-banner {
            background: linear-gradient(135deg, var(--surface2), var(--surface));
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px 24px;
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 20px; display: none;
        }
        .score-total {
            font-family: 'Syne', sans-serif; font-size: 2.5rem; font-weight: 800;
            background: linear-gradient(135deg, var(--gold), var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .score-label { font-size: 0.8rem; color: var(--muted); margin-top: 2px; }
        .score-bars { display: flex; gap: 8px; align-items: flex-end; height: 40px; }
        .score-bar-item { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .score-bar-fill {
            width: 18px; background: var(--border); border-radius: 4px;
            transition: height 0.5s, background 0.3s;
        }
        .score-bar-lbl { font-size: 0.65rem; color: var(--muted); }

        .sub-tabs { display: flex; gap: 2px; margin-bottom: 20px; background: var(--surface2); border-radius: 10px; padding: 4px; }
        .sub-tab {
            flex: 1; padding: 9px; border: none; background: none;
            color: var(--muted); font-weight: 600; font-size: 0.8rem;
            letter-spacing: 0.5px; cursor: pointer; border-radius: 8px;
            transition: background 0.2s, color 0.2s;
        }
        .sub-tab.active { background: var(--surface); color: var(--text); box-shadow: 0 1px 4px rgba(0,0,0,0.3); }

        .comp-pills { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 20px; }
        .comp-pill {
            padding: 8px 18px; border-radius: 100px;
            border: 1px solid var(--border); background: var(--surface2);
            color: var(--muted); font-weight: 700; font-size: 0.85rem;
            cursor: pointer; transition: all 0.2s; position: relative;
        }
        .comp-pill:hover { border-color: var(--accent); color: var(--text); }
        .comp-pill.active { background: var(--accent); border-color: var(--accent); color: white; }
        .comp-pill .pill-score {
            font-size: 0.65rem; position: absolute; top: -6px; right: -6px;
            background: var(--gold); color: #111; border-radius: 100px;
            padding: 1px 5px; font-weight: 800; display: none;
        }
        .comp-pill .pill-score.visible { display: block; }

        .comp-desc {
            background: rgba(230,57,70,0.08);
            border: 1px solid rgba(230,57,70,0.2);
            border-radius: var(--radius); padding: 14px 18px;
            font-size: 0.88rem; line-height: 1.6; color: var(--text);
            margin-bottom: 20px;
        }

        .score-row {
            display: flex; align-items: center; gap: 16px;
            background: var(--surface2); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 14px 18px; margin-bottom: 20px;
        }
        .score-row label { font-size: 0.8rem; color: var(--muted); font-weight: 600; white-space: nowrap; }
        .score-badges { display: flex; gap: 6px; flex-wrap: wrap; }
        .score-badge {
            padding: 6px 14px; border-radius: 100px;
            border: 1px solid var(--border); background: var(--surface);
            color: var(--muted); font-size: 0.85rem; font-weight: 700; cursor: default;
        }
        .score-badge.selected { background: var(--gold); border-color: var(--gold); color: #111; }

        .feedback-section { margin-bottom: 20px; }
        .field-label {
            font-size: 0.75rem; font-weight: 700; letter-spacing: 1px;
            text-transform: uppercase; color: var(--muted); margin-bottom: 8px;
            display: flex; align-items: center; gap: 6px;
        }
        .field-label::before { content: ''; display: block; width: 3px; height: 14px; background: var(--accent); border-radius: 2px; }
        .feedback-box {
            background: var(--surface2); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 16px;
            font-size: 0.9rem; line-height: 1.75; color: var(--text);
            min-height: 100px; white-space: pre-wrap;
        }
        .feedback-box.empty { color: var(--muted); font-style: italic; }
        .field-pos .field-label::before { background: var(--success); }

        .crit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .crit-item {
            background: var(--surface2); border: 1px solid var(--border);
            border-radius: 8px; padding: 10px 14px;
            font-size: 0.82rem; display: flex; align-items: center; gap: 10px;
            color: var(--text);
        }
        .crit-num {
            min-width: 24px; height: 24px; background: var(--surface);
            border: 1px solid var(--border); border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; font-weight: 700; color: var(--muted);
        }

        /* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #toast {
            position: fixed; bottom: 24px; right: 24px;
            background: var(--surface); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 14px 20px;
            font-size: 0.88rem; z-index: 9998;
            transform: translateY(80px); opacity: 0;
            transition: all 0.3s; max-width: 320px;
            display: flex; align-items: center; gap: 10px;
        }
        #toast.show { transform: translateY(0); opacity: 1; }
        #toast.success { border-color: var(--success); }
        #toast.error { border-color: var(--accent); }

        /* â”€â”€ SCROLLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--surface); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
    </style>
</head>
<body>

<!-- LOGIN -->
<div id="login-overlay">
    <div class="login-card">
        <div class="login-logo">ENEM PRO</div>
        <div class="login-sub">Plataforma de CorreÃ§Ã£o Inteligente</div>
        <input type="password" id="passInput" placeholder="Senha de acesso"
               onkeydown="if(event.key==='Enter') login()">
        <button class="btn-login" onclick="login()">Acessar Plataforma</button>
        <div class="login-err" id="loginErr"></div>
    </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- SISTEMA -->
<div id="main-system">
    <header>
        <div class="header-brand">ENEM PRO</div>
        <div class="header-status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusTxt">Servidor desconectado</span>
        </div>
    </header>

    <nav>
        <button class="nav-link active" onclick="showTab('scanner')">Digitalizar</button>
        <button class="nav-link" onclick="showTab('editor')">RedaÃ§Ã£o</button>
        <button class="nav-link" onclick="showTab('results')" id="navResults">Resultado</button>
        <button class="nav-link" onclick="showTab('config')">ConfiguraÃ§Ãµes</button>
    </nav>

    <main>

        <!-- SCANNER -->
        <div id="scanner" class="tab-pane active">
            <div class="card">
                <div class="card-title">ğŸ“· Digitalizar RedaÃ§Ã£o</div>

                <div class="upload-zone" id="uploadZone">
                    <input type="file" id="fileIn" accept="image/*" onchange="previewImg(this)">
                    <div class="upload-icon"><div style="font-size:2.5rem;">ğŸ“</div></div>
                    <div class="upload-text">Arraste uma imagem ou <span>clique para selecionar</span></div>
                    <div style="font-size:0.78rem; color:var(--muted); margin-top:6px;">PNG, JPG, WEBP â€” atÃ© 10MB</div>
                </div>

                <img id="prevImg">

                <!-- MÃ©todo de extraÃ§Ã£o -->
                <div style="margin-top:16px; background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius); padding:14px 16px;">
                    <div style="font-size:0.75rem; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--muted); margin-bottom:10px;">MÃ©todo de extraÃ§Ã£o</div>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; flex:1; background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:10px 14px; transition:border-color 0.2s;" id="lbl-ai">
                            <input type="radio" name="ocrMethod" value="ai" checked onchange="updateOcrMethod()" style="accent-color:var(--accent);">
                            <div>
                                <div style="font-weight:700; font-size:0.85rem;">ğŸ¤– IA (Qwen / LLM)</div>
                                <div style="font-size:0.72rem; color:var(--muted);">Melhor para letra manuscrita</div>
                            </div>
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; flex:1; background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:10px 14px; transition:border-color 0.2s;" id="lbl-tesseract">
                            <input type="radio" name="ocrMethod" value="tesseract" onchange="updateOcrMethod()" style="accent-color:var(--accent);">
                            <div>
                                <div style="font-weight:700; font-size:0.85rem;">ğŸ“„ Tesseract</div>
                                <div style="font-size:0.72rem; color:var(--muted);">Texto impresso / digitado</div>
                            </div>
                        </label>
                    </div>
                    <!-- Aviso modelos sem visÃ£o -->
                    <div id="ai-vision-warning" style="display:none; margin-top:10px; padding:8px 12px; background:rgba(244,162,97,0.1); border:1px solid rgba(244,162,97,0.3); border-radius:8px; font-size:0.78rem; color:var(--gold);">
                        âš ï¸ <b>Modelos de texto puro</b> (ex: Qwen 32B sem visÃ£o) nÃ£o processam imagens. Se falhar, o Tesseract serÃ¡ usado automaticamente â€” ou selecione Tesseract diretamente.
                    </div>
                </div>

                <div class="ocr-progress" id="ocrProgress" style="margin-top:12px;">
                    <div class="progress-track" style="height:6px;">
                        <div class="progress-fill" id="ocrBar" style="width:0%"></div>
                    </div>
                    <div style="font-size:0.78rem; color:var(--muted); margin-top:6px; text-align:center;" id="ocrMsg">Processando...</div>
                </div>

                <button class="btn btn-primary" id="btnOCR" onclick="doOCR()" style="margin-top:14px;" disabled>
                    Extrair Texto
                </button>
            </div>
        </div>

        <!-- EDITOR -->
        <div id="editor" class="tab-pane">
            <div class="card" style="margin-bottom:14px;">
                <div class="card-title" style="margin-bottom:12px;">ğŸ“‹ Tema da RedaÃ§Ã£o</div>
                <div style="font-size:0.8rem; color:var(--muted); margin-bottom:8px;">
                    Informe o tema para que a correÃ§Ã£o avalie se a redaÃ§Ã£o estÃ¡ de acordo com a proposta.
                </div>
                <input type="text" id="temaInput"
                    placeholder="Ex: A persistÃªncia da violÃªncia contra a mulher na sociedade brasileira"
                    style="width:100%; padding:12px 16px; background:var(--surface2); border:1px solid var(--border);
                           border-radius:var(--radius); color:var(--text); font-size:0.92rem; outline:none;
                           transition:border-color 0.2s; font-family:inherit;"
                    onfocus="this.style.borderColor='var(--accent)'"
                    onblur="this.style.borderColor='var(--border)'"
                    oninput="saveTema()">
                <div id="tema-warning" style="display:none; margin-top:8px; font-size:0.78rem; color:var(--gold);">
                    âš ï¸ Sem tema definido â€” a C2 serÃ¡ avaliada sem referÃªncia Ã  proposta.
                </div>
            </div>
            <div class="card">
                <div class="card-title">
                    âœï¸
                    Editor de RedaÃ§Ã£o
                </div>
                <div class="editor-meta">
                    <div class="meta-badge" id="wordCount">0 palavras</div>
                    <div class="meta-badge" id="lineCount">0 linhas</div>
                    <div class="meta-badge" id="charCount">0 caracteres</div>
                </div>
                <textarea id="essayText"
                    placeholder="Cole ou escreva sua redaÃ§Ã£o aqui..."
                    oninput="updateMeta()"></textarea>
                <div class="btn-group">
                    <button class="btn btn-primary" id="btnCorr" onclick="startCorrection()">
                        âš¡ Corrigir Agora
                    </button>
                    <button class="btn btn-secondary" onclick="clearEssay()" title="Limpar">
                        ğŸ—‘
                    </button>
                </div>
            </div>
        </div>

        <!-- RESULTS -->
        <div id="results" class="tab-pane">
            <!-- Score Banner -->
            <div class="score-banner" id="scoreBanner">
                <div>
                    <div class="score-total" id="totalScore">â€”</div>
                    <div class="score-label">Nota Total / 1000</div>
                </div>
                <div class="score-bars" id="scoreBarsViz"></div>
            </div>

            <div class="card">
                <!-- Progress -->
                <!-- Log de erros visÃ­vel -->
                <div id="errorLog" style="display:none; background:#1a0a0a; border:1px solid var(--accent); border-radius:var(--radius); padding:14px 16px; margin-bottom:16px; font-size:0.82rem; font-family:monospace; color:#ff9999; max-height:160px; overflow-y:auto; white-space:pre-wrap;"></div>

                <div class="progress-wrap" id="progWrap">
                    <div class="progress-header">
                        <span class="progress-label" id="progLabel">Iniciando anÃ¡lise...</span>
                        <span class="progress-pct" id="progPct">0%</span>
                    </div>
                    <div class="progress-track"><div class="progress-fill" id="progFill"></div></div>
                    <div class="comp-steps" id="compSteps">
                        <div class="comp-step" data-i="1"></div>
                        <div class="comp-step" data-i="2"></div>
                        <div class="comp-step" data-i="3"></div>
                        <div class="comp-step" data-i="4"></div>
                        <div class="comp-step" data-i="5"></div>
                    </div>
                </div>

                <!-- Sub-tabs -->
                <div class="sub-tabs">
                    <button class="sub-tab active" onclick="toggleSub('par')">CompetÃªncias</button>
                    <button class="sub-tab" onclick="toggleSub('ind')">Indicadores</button>
                </div>

                <!-- PARÃ‚METROS -->
                <div id="view-par">
                    <div class="comp-pills" id="compPills">
                        <div class="comp-pill active" onclick="setComp(1)">C1<span class="pill-score" id="ps1"></span></div>
                        <div class="comp-pill" onclick="setComp(2)">C2<span class="pill-score" id="ps2"></span></div>
                        <div class="comp-pill" onclick="setComp(3)">C3<span class="pill-score" id="ps3"></span></div>
                        <div class="comp-pill" onclick="setComp(4)">C4<span class="pill-score" id="ps4"></span></div>
                        <div class="comp-pill" onclick="setComp(5)">C5<span class="pill-score" id="ps5"></span></div>
                    </div>

                    <div class="comp-desc" id="compDesc">Selecione uma competÃªncia apÃ³s a correÃ§Ã£o.</div>

                    <div class="score-row">
                        <label>NOTA</label>
                        <div class="score-badges" id="scoreBadges">
                            <div class="score-badge">â€”</div>
                        </div>
                    </div>

                    <div class="feedback-section field-pos">
                        <div class="field-label">Pontos positivos</div>
                        <div class="feedback-box empty" id="posBox">Aguardando correÃ§Ã£o...</div>
                    </div>
                    <div class="feedback-section">
                        <div class="field-label">Como melhorar</div>
                        <div class="feedback-box empty" id="impBox">Aguardando correÃ§Ã£o...</div>
                    </div>
                </div>

                <!-- INDICADORES -->
                <div id="view-ind" style="display:none;">
                    <div class="comp-pills" id="compPillsInd">
                        <div class="comp-pill active" onclick="setCompInd(1)">C1</div>
                        <div class="comp-pill" onclick="setCompInd(2)">C2</div>
                        <div class="comp-pill" onclick="setCompInd(3)">C3</div>
                        <div class="comp-pill" onclick="setCompInd(4)">C4</div>
                        <div class="comp-pill" onclick="setCompInd(5)">C5</div>
                    </div>
                    <div class="crit-grid" id="critList"></div>
                </div>
            </div>
        </div>

        <!-- CONFIG -->
        <div id="config" class="tab-pane">
            <div class="card">
                <div class="card-title">
                    âš™ï¸
                    ConfiguraÃ§Ãµes
                </div>

                <div style="margin-bottom: 20px;">
                    <div class="field-label">URL do Servidor (Ngrok)</div>
                    <div class="api-config">
                        <input type="text" id="apiUrlInput" placeholder="https://xxxx.ngrok-free.app/v1/chat/completions">
                        <button class="btn-test" onclick="testConnection()">Testar ConexÃ£o</button>
                    </div>
                    <div style="font-size: 0.78rem; color: var(--muted);">
                        Atualize sempre que reiniciar o Ngrok. O status aparece no cabeÃ§alho.
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <div class="field-label">Modelo</div>
                    <div class="api-config">
                        <input type="text" id="modelInput" placeholder="local-model" value="local-model">
                    </div>
                </div>

                <div>
                    <div class="field-label">Temperatura</div>
                    <div class="api-config">
                        <input type="number" id="tempInput" min="0" max="1" step="0.05" value="0.1" style="max-width:120px;">
                        <span style="font-size:0.8rem; color:var(--muted);">Valores baixos = respostas mais consistentes (recomendado: 0.1)</span>
                    </div>
                </div>

                <button class="btn btn-primary" style="margin-top:20px; max-width:200px;" onclick="saveConfig()">
                    ğŸ’¾ Salvar
                </button>
            </div>
        </div>

    </main>
</div>

<script>


/* â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let config = {
    apiUrl: localStorage.getItem('apiUrl') || '',
    model: localStorage.getItem('model') || 'local-model',
    temp: parseFloat(localStorage.getItem('temp') || '0.1')
};

function loadConfig() {
    document.getElementById('apiUrlInput').value = config.apiUrl;
    document.getElementById('modelInput').value = config.model;
    document.getElementById('tempInput').value = config.temp;
}

/* â”€â”€ TEMA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function saveTema() {
    const tema = document.getElementById('temaInput').value.trim();
    localStorage.setItem('tema', tema);
    document.getElementById('tema-warning').style.display = tema ? 'none' : 'block';
}

function loadTema() {
    const saved = localStorage.getItem('tema') || '';
    document.getElementById('temaInput').value = saved;
    document.getElementById('tema-warning').style.display = saved ? 'none' : 'block';
}

/* â”€â”€ AVATAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const AVATAR_TIPS = {
    scanner: {
        msg: 'ğŸ“· <b>Aba Digitalizar</b><br><br>Aqui vocÃª envia uma <b>foto da redaÃ§Ã£o manuscrita</b>. O sistema extrai o texto automaticamente via OCR.<br><br>â¡ï¸ Depois clique em <b>"Extrair Texto"</b> para ir ao editor.',
        opts: ['Como tirar a foto?', 'Ir para RedaÃ§Ã£o']
    },
    editor: {
        msg: 'âœï¸ <b>Aba RedaÃ§Ã£o</b><br><br>1. Preencha o <b>tema</b> da proposta no campo acima.<br>2. Cole ou escreva sua redaÃ§Ã£o.<br>3. Clique em <b>âš¡ Corrigir Agora</b>.<br><br>O tema ajuda a IA a avaliar a C2 corretamente.',
        opts: ['O que Ã© C2?', 'Ir para Resultado']
    },
    results: {
        msg: 'ğŸ“Š <b>Aba Resultado</b><br><br>ApÃ³s a correÃ§Ã£o vocÃª verÃ¡:<br>â€¢ <b>Nota total</b> de 0 a 1000<br>â€¢ <b>C1 a C5</b> com nota, pontos positivos e como melhorar<br>â€¢ <b>Indicadores</b> detalhados por competÃªncia.',
        opts: ['O que sÃ£o C1-C5?', 'Voltar ao inÃ­cio']
    },
    config: {
        msg: 'âš™ï¸ <b>Aba ConfiguraÃ§Ãµes</b><br><br>Configure a <b>URL do Ngrok</b> gerada ao iniciar o servidor local.<br><br>âš ï¸ A URL muda toda vez que o Ngrok for reiniciado â€” lembre de atualizar aqui.',
        opts: ['Como obter a URL?', 'O que Ã© modelo?']
    }
};

const AVATAR_ANSWERS = {
    'Como tirar a foto?': 'Tire com boa iluminaÃ§Ã£o, sem sombras e com a folha bem plana. Prefira fundo claro e letras legÃ­veis. Formatos aceitos: PNG, JPG, WEBP.',
    'Ir para RedaÃ§Ã£o': () => { showTab('editor'); toggleAvatar(); },
    'O que Ã© C2?': 'C2 avalia se vocÃª compreendeu e desenvolveu o tema proposto, usando repertÃ³rio de Ã¡reas do conhecimento de forma pertinente.',
    'Ir para Resultado': () => { showTab('results'); toggleAvatar(); },
    'O que sÃ£o C1-C5?': 'SÃ£o as 5 CompetÃªncias avaliadas pelo ENEM:<br>C1: LÃ­ngua formal<br>C2: Tema e repertÃ³rio<br>C3: ArgumentaÃ§Ã£o<br>C4: CoesÃ£o<br>C5: Proposta de intervenÃ§Ã£o',
    'Voltar ao inÃ­cio': () => { showTab('scanner'); toggleAvatar(); },
    'Como obter a URL?': 'Abra o terminal no seu PC, rode <code style="background:#111;padding:2px 6px;border-radius:4px;">ngrok http 1234</code> (ou a porta do seu servidor) e copie o link <b>https://xxxx.ngrok-free.app</b>. Acrescente <b>/v1/chat/completions</b> no final.',
    'O que Ã© modelo?': 'Ã‰ o nome do modelo carregado no seu servidor local (ex: <code style="background:#111;padding:2px 6px;border-radius:4px;">local-model</code>, <code style="background:#111;padding:2px 6px;border-radius:4px;">llama3</code>, etc). Verifique no terminal do seu servidor.'
};

let avatarOpen = false;

function toggleAvatar() {
    avatarOpen = !avatarOpen;
    document.getElementById('avatar-bubble').style.display = avatarOpen ? 'block' : 'none';
    if (avatarOpen) showAvatarForTab();
}

function showAvatarForTab() {
    const active = document.querySelector('.tab-pane.active');
    const tabId = active ? active.id : 'scanner';
    const tip = AVATAR_TIPS[tabId] || AVATAR_TIPS.scanner;
    document.getElementById('avatar-msg').innerHTML = tip.msg;
    const opts = document.getElementById('avatar-options');
    opts.innerHTML = tip.opts.map(o =>
        `<button onclick="avatarAnswer('${o}')" style="
            padding:6px 12px; background:var(--surface2); border:1px solid var(--border);
            border-radius:100px; color:var(--text); font-size:0.75rem; cursor:pointer;
            transition:border-color 0.2s;" 
            onmouseover="this.style.borderColor='var(--accent)'"
            onmouseout="this.style.borderColor='var(--border)'">${o}</button>`
    ).join('');
}

function avatarAnswer(q) {
    const ans = AVATAR_ANSWERS[q];
    if (typeof ans === 'function') { ans(); return; }
    document.getElementById('avatar-msg').innerHTML = `<b>${q}</b><br><br>${ans}`;
    document.getElementById('avatar-options').innerHTML = `
        <button onclick="showAvatarForTab()" style="
            padding:6px 12px; background:var(--surface2); border:1px solid var(--border);
            border-radius:100px; color:var(--muted); font-size:0.75rem; cursor:pointer;">
            â† Voltar
        </button>`;
}

/* â”€â”€ SAVE CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function saveConfig() {
    config.apiUrl = document.getElementById('apiUrlInput').value.trim();
    config.model = document.getElementById('modelInput').value.trim() || 'local-model';
    config.temp = parseFloat(document.getElementById('tempInput').value) || 0.1;
    localStorage.setItem('apiUrl', config.apiUrl);
    localStorage.setItem('model', config.model);
    localStorage.setItem('temp', config.temp);
    showToast('ConfiguraÃ§Ãµes salvas!', 'success');
    testConnection();
}

/* â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function login() {
    const val = document.getElementById('passInput').value;
    if (val === 'beatriz') {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('main-system').style.display = 'flex';
        loadConfig();
        loadTema();
        if (config.apiUrl) testConnection();
        document.getElementById('avatar-btn').style.display = 'flex';
    } else {
        document.getElementById('loginErr').textContent = 'Senha incorreta.';
        document.getElementById('passInput').value = '';
    }
}
document.getElementById('passInput').addEventListener('keydown', e => { if(e.key==='Enter') login(); });

/* â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showTab(id) {
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    const map = { scanner: 0, editor: 1, results: 2, config: 3 };
    document.querySelectorAll('.nav-link')[map[id]].classList.add('active');
    // Atualiza o avatar se estiver aberto
    if (avatarOpen) showAvatarForTab();
}

/* â”€â”€ SUB-TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toggleSub(t) {
    const isPar = t === 'par';
    document.getElementById('view-par').style.display = isPar ? 'block' : 'none';
    document.getElementById('view-ind').style.display = isPar ? 'none' : 'block';
    document.querySelectorAll('.sub-tab').forEach((b, i) => b.classList.toggle('active', i === (isPar ? 0 : 1)));
    if (!isPar) renderCrits(curCompInd);
}

/* â”€â”€ COMPETÃŠNCIAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const COMPS = {
    1: "Demonstrar domÃ­nio da modalidade escrita formal da lÃ­ngua portuguesa.",
    2: "Compreender a proposta de redaÃ§Ã£o e aplicar conceitos das vÃ¡rias Ã¡reas do conhecimento para desenvolver o tema.",
    3: "Selecionar, relacionar, organizar e interpretar informaÃ§Ãµes, fatos, opiniÃµes e argumentos em defesa de um ponto de vista.",
    4: "Demonstrar conhecimento dos mecanismos linguÃ­sticos necessÃ¡rios para a construÃ§Ã£o da argumentaÃ§Ã£o.",
    5: "Elaborar proposta de intervenÃ§Ã£o para o problema abordado, respeitando os direitos humanos."
};

const CRITERIA = {
    1: ["Ilegibilidade/Rasuras", "MaiÃºsculas/MinÃºsculas", "Ortografia", "AcentuaÃ§Ã£o", "TranslineaÃ§Ã£o", "HÃ­fen", "PontuaÃ§Ã£o/Truncamento", "PontuaÃ§Ã£o/JustaposiÃ§Ã£o", "Outros de pontuaÃ§Ã£o", "Sintaxe/Falta", "Sintaxe/Excesso", "Crase", "RegÃªncia", "ConcordÃ¢ncia", "Modo/Tempo Verbal", "Pronomes", "Paralelismo", "VocabulÃ¡rio", "Coloquialismo", "Linguagem Figurada"],
    2: ["Tangenciamento", "Tipo textual inadequado", "RepertÃ³rio restrito", "RepertÃ³rio nÃ£o legitimado", "RepertÃ³rio nÃ£o pertinente", "RepertÃ³rio improdutivo", "RepertÃ³rio legitimado/produtivo"],
    3: ["Tangenciamento temÃ¡tico", "Relacionamento de ideias", "Texto expositivo", "Desenvolvimento inadequado", "ArgumentaÃ§Ã£o confusa", "ContradiÃ§Ã£o", "RepetiÃ§Ã£o de ideias", "Prolixo", "ModalizaÃ§Ã£o", "ProgressÃ£o textual", "Tese clara", "Proposta de intervenÃ§Ã£o", "Bem argumentado", "EstratÃ©gico"],
    4: ["Coesivo interparÃ¡grafo", "Uso de operadores", "Ambiguidade", "Mau uso de conectivos", "RepetiÃ§Ã£o lÃ©xica"],
    5: ["Sem proposta", "Proposta sem relaÃ§Ã£o com assunto", "Respeito aos direitos humanos", "Tangenciamento da proposta", "Proposta condicional", "Agente especificado", "AÃ§Ã£o detalhada", "Meio/Modo especificado", "Efeito esperado", "Detalhamento completo", "Proposta completa"]
};

const SCORES = [0, 40, 80, 120, 160, 200];

let feedbackData = {};
let curComp = 1;
let curCompInd = 1;

function setComp(n) {
    curComp = n;
    document.querySelectorAll('#compPills .comp-pill').forEach((b, i) => b.classList.toggle('active', i+1 === n));
    document.getElementById('compDesc').innerText = COMPS[n];

    const score = feedbackData[`c${n}_score`];
    const badges = document.getElementById('scoreBadges');
    badges.innerHTML = SCORES.map(s =>
        `<div class="score-badge${s === score ? ' selected' : ''}">${s}</div>`
    ).join('');

    const pos = feedbackData[`c${n}_pos`];
    const imp = feedbackData[`c${n}_imp`];
    const posBox = document.getElementById('posBox');
    const impBox = document.getElementById('impBox');
    posBox.innerText = pos || 'Aguardando correÃ§Ã£o...';
    posBox.classList.toggle('empty', !pos);
    impBox.innerText = imp || 'Aguardando correÃ§Ã£o...';
    impBox.classList.toggle('empty', !imp);
}

function setCompInd(n) {
    curCompInd = n;
    document.querySelectorAll('#compPillsInd .comp-pill').forEach((b, i) => b.classList.toggle('active', i+1 === n));
    renderCrits(n);
}

function renderCrits(n) {
    const offsets = [0, 0, 20, 27, 41, 46];
    const list = document.getElementById('critList');
    list.innerHTML = CRITERIA[n].map((c, i) =>
        `<div class="crit-item"><div class="crit-num">${offsets[n]+i+1}</div>${c}</div>`
    ).join('');
}

/* â”€â”€ WORD COUNT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateMeta() {
    const txt = document.getElementById('essayText').value;
    const words = txt.trim() ? txt.trim().split(/\s+/).length : 0;
    const lines = txt.trim() ? txt.split('\n').length : 0;
    document.getElementById('wordCount').textContent = `${words} palavras`;
    document.getElementById('lineCount').textContent = `${lines} linhas`;
    document.getElementById('charCount').textContent = `${txt.length} caracteres`;
}

function clearEssay() {
    document.getElementById('essayText').value = '';
    updateMeta();
}

/* â”€â”€ SCANNER / OCR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function previewImg(input) {
    const file = input.files[0];
    if (!file) return;
    const r = new FileReader();
    r.onload = e => {
        const img = document.getElementById('prevImg');
        img.src = e.target.result;
        img.style.display = 'block';
        document.getElementById('btnOCR').disabled = false;
    };
    r.readAsDataURL(file);
}

function updateOcrMethod() {
    const isAI = document.querySelector('input[name="ocrMethod"]:checked').value === 'ai';
    document.getElementById('lbl-ai').style.borderColor = isAI ? 'var(--accent)' : 'var(--border)';
    document.getElementById('lbl-tesseract').style.borderColor = !isAI ? 'var(--accent)' : 'var(--border)';
    document.getElementById('ai-vision-warning').style.display = isAI ? 'block' : 'none';
}

async function doOCR() {
    const btn = document.getElementById('btnOCR');
    const prog = document.getElementById('ocrProgress');
    const bar = document.getElementById('ocrBar');
    const msg = document.getElementById('ocrMsg');
    const method = document.querySelector('input[name="ocrMethod"]:checked').value;

    btn.disabled = true;
    prog.style.display = 'block';
    bar.style.width = '10%';

    if (method === 'ai') {
        await doOcrAI(btn, prog, bar, msg);
    } else {
        await doOcrTesseract(btn, prog, bar, msg);
    }
}

async function doOcrAI(btn, prog, bar, msg) {
    if (!config.apiUrl) {
        showToast('Configure a URL do servidor nas ConfiguraÃ§Ãµes!', 'error');
        prog.style.display = 'none';
        btn.disabled = false;
        return;
    }

    msg.textContent = 'Enviando imagem para a IA...';
    bar.style.width = '30%';

    // Converte imagem para base64
    const imgSrc = document.getElementById('prevImg').src;
    const base64 = imgSrc.split(',')[1];
    const mimeMatch = imgSrc.match(/data:(image\/\w+);/);
    const mime = mimeMatch ? mimeMatch[1] : 'image/jpeg';

    try {
        msg.textContent = 'IA transcrevendo manuscrito...';
        bar.style.width = '60%';

        const resp = await fetch(config.apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'ngrok-skip-browser-warning': 'true'
            },
            body: JSON.stringify({
                model: config.model,
                messages: [
                    {
                        role: 'system',
                        content: 'VocÃª Ã© um transcritor de redaÃ§Ãµes. ReceberÃ¡ uma IMAGEM de uma folha de redaÃ§Ã£o manuscrita do ENEM. Transcreva o texto exatamente como estÃ¡ escrito, linha por linha, sem corrigir erros ortogrÃ¡ficos ou gramaticais, sem comentÃ¡rios adicionais. Retorne somente o texto transcrito.'
                    },
                    {
                        role: 'user',
                        content: [
                            {
                                type: 'image_url',
                                image_url: {
                                    url: `data:${mime};base64,${base64}`,
                                    detail: 'high'
                                }
                            },
                            {
                                type: 'text',
                                text: 'Esta Ã© uma IMAGEM de uma redaÃ§Ã£o manuscrita. Transcreva todo o texto visÃ­vel, linha por linha.'
                            }
                        ]
                    }
                ],
                temperature: 0.1,
                max_tokens: 2000
            }),
            signal: AbortSignal.timeout(120000)
        });

        if (!resp.ok) {
            const err = await resp.text();
            // Modelo sem suporte a imagens â†’ tenta Tesseract automaticamente
            if (resp.status === 400 && err.includes('image')) {
                showToast('Modelo nÃ£o suporta imagens â€” usando Tesseract como fallback.', 'error');
                await doOcrTesseract(btn, prog, bar, msg);
                return;
            }
            throw new Error(`HTTP ${resp.status}: ${err.slice(0,150)}`);
        }

        const data = await resp.json();
        const text = data.choices?.[0]?.message?.content;

        // Verifica se o modelo recusou a imagem na resposta
        if (!text || text.toLowerCase().includes("don't support") || text.toLowerCase().includes("nÃ£o suport") || text.toLowerCase().includes("cannot process image")) {
            showToast('Modelo nÃ£o suporta imagens â€” usando Tesseract como fallback.', 'error');
            await doOcrTesseract(btn, prog, bar, msg);
            return;
        }

        bar.style.width = '100%';
        msg.textContent = 'TranscriÃ§Ã£o concluÃ­da!';
        document.getElementById('essayText').value = text;
        updateMeta();

        setTimeout(() => {
            prog.style.display = 'none';
            btn.disabled = false;
            showToast('Texto extraÃ­do pela IA! Revise no editor.', 'success');
            showTab('editor');
        }, 800);

    } catch(e) {
        prog.style.display = 'none';
        btn.disabled = false;
        showToast('Erro na IA: ' + e.message, 'error');
    }
}

async function doOcrTesseract(btn, prog, bar, msg) {
    msg.textContent = 'Iniciando Tesseract...';
    try {
        const res = await Tesseract.recognize(
            document.getElementById('prevImg').src, 'por',
            { logger: m => {
                if (m.status === 'recognizing text') {
                    const pct = Math.round(m.progress * 100);
                    bar.style.width = pct + '%';
                    msg.textContent = `Reconhecendo texto... ${pct}%`;
                }
            }}
        );
        document.getElementById('essayText').value = res.data.text;
        updateMeta();
        prog.style.display = 'none';
        btn.disabled = false;
        showToast('Texto extraÃ­do! Revise no editor.', 'success');
        showTab('editor');
    } catch(e) {
        prog.style.display = 'none';
        btn.disabled = false;
        showToast('Erro no Tesseract: ' + e.message, 'error');
    }
}

/* â”€â”€ API CONNECTION TEST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// Ngrok bloqueia requisiÃ§Ãµes de teste (tela de aviso causa delay >30s).
// Validamos apenas o formato da URL â€” a conexÃ£o real Ã© testada na primeira correÃ§Ã£o.
function testConnection() {
    const dot = document.getElementById('statusDot');
    const txt = document.getElementById('statusTxt');
    const url = (config.apiUrl || '').trim();

    if (!url) {
        dot.className = 'status-dot error';
        txt.textContent = 'URL nÃ£o configurada';
        return false;
    }

    const isValid = /^https?:\/\/.+/.test(url);
    if (isValid) {
        dot.className = 'status-dot online';
        txt.textContent = 'URL configurada âœ“';
    } else {
        dot.className = 'status-dot error';
        txt.textContent = 'URL invÃ¡lida';
    }
    return isValid;
}

/* â”€â”€ CORREÃ‡ÃƒO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function startCorrection() {
    const txt = document.getElementById('essayText').value.trim();
    if (!txt) { showToast('Cole sua redaÃ§Ã£o antes de corrigir!', 'error'); return; }
    if (!config.apiUrl) {
        showToast('Configure a URL do servidor primeiro!', 'error');
        showTab('config');
        return;
    }

    const tema = document.getElementById('temaInput').value.trim();
    if (!tema) {
        document.getElementById('tema-warning').style.display = 'block';
    }
    const btn = document.getElementById('btnCorr');
    const errorLog = document.getElementById('errorLog');
    btn.disabled = true;
    feedbackData = {};
    showTab('results');

    // Reset UI
    document.getElementById('scoreBanner').style.display = 'none';
    document.getElementById('progWrap').style.display = 'block';
    errorLog.style.display = 'none';
    errorLog.textContent = '';
    document.querySelectorAll('.comp-step').forEach(s => s.className = 'comp-step');
    setComp(1);

    const logError = (msg) => {
        errorLog.style.display = 'block';
        errorLog.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
        errorLog.scrollTop = errorLog.scrollHeight;
    };

    const setProgress = (pct, label) => {
        document.getElementById('progFill').style.width = pct + '%';
        document.getElementById('progLabel').textContent = label;
        document.getElementById('progPct').textContent = pct + '%';
    };

    for (let i = 1; i <= 5; i++) {
        document.querySelectorAll('.comp-step').forEach((s, idx) => {
            if (idx + 1 < i) s.className = 'comp-step done';
            else if (idx + 1 === i) s.className = 'comp-step active';
            else s.className = 'comp-step';
        });

        setProgress((i - 1) * 20, `Analisando CompetÃªncia ${i} de 5...`);
        await new Promise(r => setTimeout(r, 80));

        const tema = document.getElementById('temaInput').value.trim();
        const temaInfo = tema ? `\nTema da proposta: "${tema}"` : '';
        const systemPrompt = `VocÃª Ã© um corretor oficial de redaÃ§Ãµes do ENEM.${temaInfo}
Analise APENAS a CompetÃªncia ${i}: "${COMPS[i]}"${i === 2 && tema ? '\nVerifique se o texto aborda corretamente o tema informado.' : ''}
Retorne SOMENTE um JSON vÃ¡lido, sem texto adicional, sem markdown:
{"c${i}_score": <nota entre 0,40,80,120,160,200>, "c${i}_pos": "<pontos positivos detalhados>", "c${i}_imp": "<como melhorar detalhadamente>"}`;

        let success = false;
        let lastError = '';

        for (let attempt = 1; attempt <= 2; attempt++) {
            try {
                logError(`C${i} â€” tentativa ${attempt}: enviando requisiÃ§Ã£o...`);

                const resp = await fetch(config.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({
                        model: config.model,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: txt
                                    }
                                ]
                            }
                        ],
                        temperature: config.temp,
                        max_tokens: 800
                    }),
                    signal: AbortSignal.timeout(120000)
                });

                if (!resp.ok) {
                    const errBody = await resp.text();
                    throw new Error(`HTTP ${resp.status}: ${errBody.slice(0, 200)}`);
                }

                const data = await resp.json();
                logError(`C${i} â€” resposta recebida, parseando JSON...`);

                if (!data.choices?.[0]?.message?.content) {
                    logError(`C${i} â€” resposta da API: ${JSON.stringify(data).slice(0,300)}`);
                    throw new Error('Resposta sem conteÃºdo em choices[0].message.content');
                }

                const raw = data.choices[0].message.content;
                logError(`C${i} â€” conteÃºdo bruto: ${raw.slice(0, 200)}`);

                const match = raw.match(/\{[\s\S]*\}/);
                if (!match) throw new Error(`JSON nÃ£o encontrado. Resposta: ${raw.slice(0,200)}`);

                const parsed = JSON.parse(match[0]);
                feedbackData = { ...feedbackData, ...parsed };

                const ps = document.getElementById(`ps${i}`);
                if (ps) { ps.textContent = parsed[`c${i}_score`] ?? '?'; ps.classList.add('visible'); }

                logError(`C${i} â€” âœ“ nota: ${parsed['c'+i+'_score']}`);
                success = true;
                break;

            } catch (e) {
                lastError = e.message;
                logError(`C${i} â€” ERRO tentativa ${attempt}: ${e.message}`);
                if (attempt < 2) {
                    setProgress((i-1)*20, `C${i} â€” Retentando em 3s...`);
                    await new Promise(r => setTimeout(r, 3000));
                }
            }
        }

        if (!success) {
            document.querySelectorAll('.comp-step').forEach((s, idx) => {
                if (idx + 1 === i) s.className = 'comp-step error';
            });
            setProgress((i-1)*20, `âŒ Falha na CompetÃªncia ${i}`);
            btn.disabled = false;
            showToast(`Falha na C${i} â€” veja o log de erros acima`, 'error');
            return;
        }
    }

    // FinalizaÃ§Ã£o com banner grande
    document.querySelectorAll('.comp-step').forEach(s => s.className = 'comp-step done');
    setProgress(100, 'âœ… CorreÃ§Ã£o finalizada!');

    const total = [1,2,3,4,5].reduce((acc, n) => acc + (feedbackData[`c${n}_score`] || 0), 0);
    document.getElementById('totalScore').textContent = total;
    document.getElementById('scoreBanner').style.display = 'flex';
    renderScoreBars();

    // Esconde log se tudo OK
    errorLog.style.display = 'none';

    await new Promise(r => setTimeout(r, 800));
    document.getElementById('progWrap').style.display = 'none';
    btn.disabled = false;
    setComp(1);

    // Toast persistente de conclusÃ£o (8s)
    const el = document.getElementById('toast');
    el.innerHTML = `<span style="color:var(--success); font-weight:700; font-size:1.1rem;">âœ“</span> <span>CorreÃ§Ã£o concluÃ­da! <b>Nota total: ${total}/1000</b></span>`;
    el.className = 'show success';
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => el.className = '', 8000);
}

function renderScoreBars() {
    const wrap = document.getElementById('scoreBarsViz');
    wrap.innerHTML = [1,2,3,4,5].map(n => {
        const s = feedbackData[`c${n}_score`] || 0;
        const h = Math.round((s / 200) * 40);
        const col = s >= 160 ? 'var(--success)' : s >= 80 ? 'var(--gold)' : 'var(--accent)';
        return `<div class="score-bar-item">
            <div class="score-bar-fill" style="height:${h}px; background:${col};"></div>
            <div class="score-bar-lbl">C${n}</div>
        </div>`;
    }).join('');
}

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let toastTimer;
function showToast(msg, type = '') {
    const el = document.getElementById('toast');
    const icon = type === 'success' ? 'âœ“' : type === 'error' ? 'âœ•' : 'â„¹';
    el.innerHTML = `<span style="color:${type==='success'?'var(--success)':'var(--accent)'}; font-weight:700;">${icon}</span> ${msg}`;
    el.className = `show ${type}`;
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => el.className = '', 3500);
}

// Init
document.addEventListener('DOMContentLoaded', () => {
});
renderCrits(1);
</script>

<!-- â”€â”€ AVATAR ASSISTENTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="avatar-btn" onclick="toggleAvatar()" title="Ajuda" style="
    position:fixed; bottom:24px; left:24px; z-index:9990;
    width:54px; height:54px; border-radius:50%;
    background:linear-gradient(135deg,#e63946,#f4a261);
    display:none; align-items:center; justify-content:center;
    cursor:pointer;
    box-shadow:0 4px 20px rgba(230,57,70,0.4);
    transition:transform 0.2s, box-shadow 0.2s;
    border:2px solid rgba(255,255,255,0.15);"
    onmouseover="this.style.transform='scale(1.1)'"
    onmouseout="this.style.transform='scale(1)'">
    <svg width="34" height="34" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
  <!-- Cabelo -->
  <ellipse cx="32" cy="22" rx="18" ry="17" fill="#3d1f0a"/>
  <rect x="14" y="22" width="7" height="20" rx="3" fill="#3d1f0a"/>
  <rect x="43" y="22" width="7" height="20" rx="3" fill="#3d1f0a"/>
  <!-- Rosto -->
  <ellipse cx="32" cy="28" rx="14" ry="15" fill="#c68642"/>
  <!-- Olhos -->
  <ellipse cx="26" cy="26" rx="2.5" ry="3" fill="#1a0a00"/>
  <ellipse cx="38" cy="26" rx="2.5" ry="3" fill="#1a0a00"/>
  <circle cx="27" cy="25" r="0.8" fill="white"/>
  <circle cx="39" cy="25" r="0.8" fill="white"/>
  <!-- Sobrancelhas -->
  <path d="M23 22 Q26 20.5 29 22" stroke="#3d1f0a" stroke-width="1.5" stroke-linecap="round" fill="none"/>
  <path d="M35 22 Q38 20.5 41 22" stroke="#3d1f0a" stroke-width="1.5" stroke-linecap="round" fill="none"/>
  <!-- Nariz -->
  <ellipse cx="32" cy="31" rx="1.5" ry="1" fill="#a0622a"/>
  <!-- Boca sorrindo -->
  <path d="M27 35 Q32 39 37 35" stroke="#7a3d1a" stroke-width="1.8" stroke-linecap="round" fill="none"/>
  <!-- Bochechas -->
  <ellipse cx="22" cy="32" rx="3" ry="2" fill="#e07050" opacity="0.35"/>
  <ellipse cx="42" cy="32" rx="3" ry="2" fill="#e07050" opacity="0.35"/>
  <!-- Corpo/blusa -->
  <path d="M18 56 Q18 48 32 46 Q46 48 46 56" fill="#e63946"/>
</svg>
</div>

<div id="avatar-bubble" style="
    position:fixed; bottom:90px; left:24px; z-index:9989;
    width:300px; background:var(--surface);
    border:1px solid var(--border); border-radius:16px;
    padding:18px; display:none;
    box-shadow:0 8px 30px rgba(0,0,0,0.4);
    animation: fadeIn 0.25s ease;">
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px; border-bottom:1px solid var(--border); padding-bottom:10px;">
        <div><svg width="42" height="42" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
  <ellipse cx="32" cy="22" rx="18" ry="17" fill="#3d1f0a"/>
  <rect x="14" y="22" width="7" height="20" rx="3" fill="#3d1f0a"/>
  <rect x="43" y="22" width="7" height="20" rx="3" fill="#3d1f0a"/>
  <ellipse cx="32" cy="28" rx="14" ry="15" fill="#c68642"/>
  <ellipse cx="26" cy="26" rx="2.5" ry="3" fill="#1a0a00"/>
  <ellipse cx="38" cy="26" rx="2.5" ry="3" fill="#1a0a00"/>
  <circle cx="27" cy="25" r="0.8" fill="white"/>
  <circle cx="39" cy="25" r="0.8" fill="white"/>
  <path d="M23 22 Q26 20.5 29 22" stroke="#3d1f0a" stroke-width="1.5" stroke-linecap="round" fill="none"/>
  <path d="M35 22 Q38 20.5 41 22" stroke="#3d1f0a" stroke-width="1.5" stroke-linecap="round" fill="none"/>
  <ellipse cx="32" cy="31" rx="1.5" ry="1" fill="#a0622a"/>
  <path d="M27 35 Q32 39 37 35" stroke="#7a3d1a" stroke-width="1.8" stroke-linecap="round" fill="none"/>
  <ellipse cx="22" cy="32" rx="3" ry="2" fill="#e07050" opacity="0.35"/>
  <ellipse cx="42" cy="32" rx="3" ry="2" fill="#e07050" opacity="0.35"/>
  <path d="M18 56 Q18 48 32 46 Q46 48 46 56" fill="#e63946"/>
</svg></div>
        <div>
            <div style="font-weight:700; font-size:0.9rem; font-family:'Syne',sans-serif;">ENEM Assistente</div>
            <div style="font-size:0.72rem; color:var(--success);">â— Online</div>
        </div>
        <button onclick="toggleAvatar()" style="margin-left:auto; background:none; border:none; color:var(--muted); cursor:pointer; font-size:1rem;">âœ•</button>
    </div>
    <div id="avatar-msg" style="font-size:0.85rem; line-height:1.6; color:var(--text); min-height:60px;"></div>
    <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:12px;" id="avatar-options"></div>
</div>
</body>
</html>
